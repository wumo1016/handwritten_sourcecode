<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>

<body>
  <button onclick="history.push('/')">首页</button>
  <button onclick="history.push('/about')">关于我</button>
  <button onclick="history.replace('/replace')">替换</button>

  <script>

    // 路由系统基本的: 
    // 1路径 2.当前路径下的状态 
    // 3.两个切换路径的方法 push/replace
    // 4.路径变化 需要通知用户
    /**
     * @Author: wyb
     * @Descripttion: 获取当前路径
     * @param {*}
     */
    function createCurrentLoaction() {
      const { pathname, search, hash } = window.location
      return pathname + search + hash
    }
    /**
     * @Author: wyb
     * @Descripttion: 创建自己的页面状态
     * @param {*} back 后退路径
     * @param {*} current 当前路径
     * @param {*} forward 前进路径
     * @param {*} replace 是否是替换路径
     * @param {*} computedScroll 是否记录滚动条
     */
    function buildState(back, current, forward, replace = false, computedScroll = false) {
      return {
        back,
        current,
        forward,
        replace,
        scroll: computedScroll ? { left: window.pageXOffset, top: window.pageYOffset } : null,
        position: window.history.length - 1
      }
    }
    /**
     * @Author: wyb
     * @Descripttion: 
     * @param {*}
     */
    function useHistoryStateNvigation() {
      const currentLocation = {
        value: createCurrentLoaction()
      }
      const historyState = {
        value: window.history.state
      }
      // 第一次刷新页面的时候没有状态 维护一个自己的状态
      if (!historyState.state) {
        changeLocation(currentLocation.value, buildState(null, currentLocation.value, null, true), true)
      }
      // 同步状态进 history.state
      function changeLocation(to, state, replace) {
        window.history[replace ? 'replaceState' : 'pushState'](state, null, to)
        historyState.value = state
      }

      function push(to, data) {
        //  维护一个跳转前状态 当前+去哪
        const currentState = Object.assign({}, historyState.value, {
          forward: to,
          scroll: { left: window.pageXOffset, top: window.pageYOffset }
        })
        // 本质没有跳转 只是更新了状态 后续在vue中可以监控状态的变化
        changeLocation(currentState.current, currentState, true)
        const state = Object.assign({}, buildState(currentLocation.value, to, null), {
          position: currentState.position + 1
        }, data)
        changeLocation(to, state, false)
        currentLocation.value = to
      }

      function replace(to, data) {
        const state = Object.assign({}, buildState(historyState.value.back, to, historyState.value.forward, true), data)
        changeLocation(to, state, true)
        currentLocation.value = to
      }

      return {
        location: currentLocation,
        state: historyState,
        push,
        replace
      }
    }
    // 前进后退的时候要更新 currentLocation historyState
    function useHistoryListeners(historyState, currentLocation) {
      let listeners = []
      const popStateHandler = ({ state }) => {
        const from = currentLocation.value // 从哪来
        const to = createCurrentLoaction() // 去哪
        const fromState = historyState.value

        currentLocation.value = to
        historyState.value = state

        const isBack = state.position < fromState.position

        listeners.forEach(cb => cb(to, from, { isBack }))
      }
      // 只能监听浏览器的前进后退
      window.addEventListener('popstate', popStateHandler)

      function listen(cb) {
        listeners.push(cb)
      }

      return {
        listen
      }
    }
    /**
     * @Author: wyb
     * @Descripttion: 
     * @param {*}
     */
    function createWebHistory() {
      const historyNavigation = useHistoryStateNvigation()

      const historyListeners = useHistoryListeners(historyNavigation.state, historyNavigation.location)

      const routerHistory = Object.assign({}, historyNavigation, historyListeners)

      Object.defineProperty(routerHistory, 'location', {
        get() {
          return historyNavigation.location.value
        }
      })

      Object.defineProperty(routerHistory, 'state', {
        get() {
          return historyNavigation.state.value
        }
      })

      return routerHistory
    }

    const routerHistory = createWebHistory()
    console.log(routerHistory.location);
    console.log(routerHistory.state);

    routerHistory.listen((to, from) => {
      console.log(to, from);
    })

  </script>
</body>

</html>